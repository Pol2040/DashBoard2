<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard RRSS ObSBA</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300..800;1,300..800&display=swap"
    rel="stylesheet">

  <!-- Google Charts -->
  <script src="https://www.gstatic.com/charts/loader.js"></script>

  <style>
    :root {
      --primary: #cbd5e1;
      /* Gris plateado suave */
      --primary-hover: #f8fafc;
      --bg-color: #0f172a;
      /* Azul grisáceo muy oscuro (Deep Space) */
      --card-bg: #1e293b;
      /* Gris pizarra oscuro */
      --text-main: #f1f5f9;
      /* Texto casi blanco */
      --text-muted: #94a3b8;
      /* Gris azulado para texto secundario */
      --accent: #38bdf8;
      /* Celeste vibrante para acentos */
      --success: #22c55e;
      --warning: #eab308;
      --danger: #f43f5e;
      --border-color: #334155;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.4);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.4);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --glass-bg: rgba(30, 41, 59, 0.4);
      --glass-bg-alt: rgba(15, 23, 42, 0.4);
    }

    body.light-mode {
      --primary: #334155;
      --primary-hover: #1e293b;
      --bg-color: #e5e7eb;
      /* Gris claro sutil */
      --card-bg: #f8fafc;
      /* Blanco grisáceo */
      --text-main: #1f2937;
      /* Gris casi negro */
      --text-muted: #4b5563;
      /* Gris intermedio */
      --accent: #2563eb;
      /* Azul real más sobrio */
      --border-color: #d1d5db;
      /* Gris para bordes */
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.1);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.15);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
      --glass-bg: rgba(229, 231, 235, 0.8);
      --glass-bg-alt: rgba(209, 213, 219, 0.8);
    }

    /* ================= ESTILO GENERAL ================= */
    body {
      font-family: 'Open Sans', sans-serif;
      background-color: var(--bg-color);
      margin: 0;
      padding: 0;
      color: var(--text-main);
      line-height: 1.5;
      min-height: 100vh;
      overflow-x: hidden;
    }

    .dashboard-container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 0.5rem;
    }

    @media (min-width: 768px) {
      .dashboard-container {
        padding: 2rem;
      }
    }

    h1 {
      color: var(--primary);
      font-weight: 800;
      font-size: 1.75rem;
      margin-bottom: 2rem;
      text-align: center;
      position: relative;
      padding-bottom: 1rem;
    }

    h1::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 60px;
      height: 4px;
      background: var(--primary);
      border-radius: 2px;
    }

    /* ================= LAYOUT ================= */
    .app-layout {
      display: flex;
      min-height: 100vh;
      flex-direction: column;
    }

    @media (min-width: 1024px) {
      .app-layout {
        flex-direction: row;
      }
    }

    /* ================= SIDEBAR ================= */
    .sidebar {
      width: 100%;
      background: var(--card-bg);
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      z-index: 1000;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @media (min-width: 1024px) {
      .sidebar {
        width: 300px;
        position: sticky;
        top: 0;
        height: 100vh;
        overflow-y: auto;
      }

      .sidebar.collapsed {
        margin-left: -300px;
        transform: translateX(0);
      }
    }

    @media (max-width: 1023px) {
      .sidebar {
        position: fixed;
        left: 0;
        top: 0;
        height: 100vh;
        width: 280px;
        transform: translateX(-101%);
      }

      .sidebar.active {
        transform: translateX(0);
      }
    }

    /* Backdrop for mobile */
    .sidebar-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      z-index: 999;
      display: none;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .sidebar-overlay.active {
      display: block;
      opacity: 1;
    }

    .sidebar-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .sidebar-header h2 {
      margin: 0;
      font-size: 1.125rem;
      font-weight: 800;
      color: var(--primary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* Toggle Buttons */
    .toggle-btn {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      color: var(--text-main);
      padding: 0.5rem;
      border-radius: 0.5rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
      z-index: 1001;
    }

    .toggle-btn:hover {
      background: var(--border-color);
      color: var(--accent);
    }

    .desktop-toggle {
      display: none;
    }

    @media (min-width: 1024px) {
      .desktop-toggle {
        display: flex;
        position: fixed;
        left: 1rem;
        top: 1rem;
      }

      /* Shift toggle when sidebar is open if desired, or keep it floating */
      .sidebar.collapsed~.main-content .desktop-toggle {
        left: 1rem;
      }
    }

    .mobile-nav-toggle {
      position: fixed;
      top: 1rem;
      left: 1rem;
      display: flex;
    }

    @media (min-width: 1024px) {
      .mobile-nav-toggle {
        display: none;
      }
    }

    .sidebar-content {
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }

    .sidebar-section h3 {
      font-size: 0.75rem;
      font-weight: 700;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: 1rem;
      padding-left: 0.5rem;
    }

    .nav-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    @media (min-width: 1024px) {
      .nav-list {
        flex-direction: column;
      }
    }

    .nav-item {
      width: auto;
    }

    @media (min-width: 1024px) {
      .nav-item {
        width: 100%;
      }
    }

    .nav-btn {
      width: 100%;
      text-align: left;
      padding: 0.75rem 1rem;
      background: transparent;
      border: 1px solid var(--border-color);
      border-radius: 0.75rem;
      color: var(--text-main);
      font-size: 0.9375rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .nav-btn:hover {
      background: rgba(56, 189, 248, 0.1);
      border-color: var(--accent);
      color: var(--accent);
    }

    .nav-btn.active {
      background: var(--accent);
      border-color: var(--accent);
      color: var(--bg-color);
      box-shadow: 0 4px 12px rgba(56, 189, 248, 0.3);
    }

    .main-content {
      flex: 1;
      padding: 0.5rem;
      overflow-x: hidden;
    }

    @media (min-width: 768px) {
      .main-content {
        padding: 2.5rem;
      }
    }

    /* Mobile Toggle (Optional, can just keep it visible as header on small screens) */
    .mobile-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 1.5rem;
      background: var(--card-bg);
      border-bottom: 1px solid var(--border-color);
    }

    @media (min-width: 1024px) {
      .mobile-header {
        display: none;
      }
    }

    /* ================= CARD CONTENEDOR GRÁFICO ================= */
    .chart-card {
      padding: 1.5rem 0;
      margin-top: 1.5rem;
    }

    .card-title {
      text-align: center;
      color: var(--primary);
      font-weight: 700;
      font-size: 1.25rem;
      margin-bottom: 1.5rem;
    }

    #chart_area {
      width: 100%;
      min-height: 350px;
      overflow: hidden;
    }

    @media (min-width: 768px) {
      #chart_area {
        min-height: 520px;
      }
    }

    .info {
      text-align: center;
      color: var(--danger);
      margin-top: 1rem;
      font-weight: 600;
    }

    /* ================= AUX CARDS GROUP ================= */
    .aux-group {
      margin-top: 2.5rem;
      padding: 1.5rem;
      background: linear-gradient(135deg, var(--glass-bg), var(--glass-bg-alt));
      border-radius: 1.25rem;
      border: 1px solid var(--border-color);
      display: none;
      /* Se muestra dinámicamente */
      flex-direction: column;
      align-items: center;
      backdrop-filter: blur(8px);
    }

    .aux-subtitle {
      text-align: center;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 1.5rem;
      font-size: 1.125rem;
      width: 100%;
    }

    #auxCardsContainer {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 1rem;
      width: 100%;
    }

    .aux-card {
      padding: 1.25rem;
      min-width: 180px;
      flex: 1 1 200px;
      max-width: 300px;
      border-bottom: 1px solid var(--border-color);
    }

    .aux-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .aux-row {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .aux-label {
      font-size: 0.75rem;
      font-weight: 700;
      color: var(--text-muted);
      text-transform: uppercase;
    }

    .aux-value {
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--text-main);
    }

    /* ================= GRID DE TARJETAS TOP ================= */
    .card-grid {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 1.5rem;
      padding: 1.5rem 0;
    }

    .card {
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      position: relative;
      transition: var(--transition);
      flex: 1 1 280px;
      max-width: 400px;
      border-bottom: 1px solid var(--border-color);
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-lg);
    }

    .card-top {
      border-top: 5px solid var(--primary);
    }

    .card-rank {
      font-weight: 800;
      color: var(--primary);
      font-size: 1rem;
      background: rgba(99, 102, 241, 0.1);
      padding: 0.25rem 0.75rem;
      border-radius: 2rem;
      align-self: flex-start;
    }

    .card-main {
      font-size: 1.75rem;
      font-weight: 800;
      color: var(--text-main);
    }

    .card-stats {
      font-size: 0.9375rem;
      color: var(--text-main);
      line-height: 1.6;
    }

    .card-stats hr {
      border: 0;
      border-top: 1px solid var(--border-color);
      margin: 0.75rem 0;
    }

    .card-link {
      margin-top: auto;
      font-weight: 700;
      color: var(--primary);
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      transition: var(--transition);
    }

    .card-link:hover {
      color: var(--primary-hover);
      transform: translateX(3px);
    }

    /* ================= RESPONSIVE ADJUSTMENTS ================= */

    @media (max-width: 640px) {
      h1 {
        font-size: 1.5rem;
        margin-bottom: 1rem;
      }

      .card-main {
        font-size: 1.5rem;
      }

      .aux-value {
        font-size: 1.25rem;
      }

      .chart-card {
        margin-top: 0.5rem;
        padding: 0.5rem 0;
      }

      .card-title {
        margin-bottom: 0.75rem;
        font-size: 1.1rem;
      }
    }

    /* ================= FILTRO DE AÑOS ================= */
    .filter-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .filter-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.5rem 0.75rem;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: var(--transition);
      border: 1px solid transparent;
    }

    .filter-item:hover {
      background: rgba(56, 189, 248, 0.1);
      border-color: var(--border-color);
    }

    .filter-item input[type="checkbox"] {
      appearance: none;
      -webkit-appearance: none;
      width: 1.25rem;
      height: 1.25rem;
      border: 2px solid var(--border-color);
      border-radius: 0.25rem;
      background: transparent;
      cursor: pointer;
      position: relative;
      transition: var(--transition);
    }

    .filter-item input[type="checkbox"]:checked {
      background: var(--accent);
      border-color: var(--accent);
    }

    .filter-item input[type="checkbox"]:checked::after {
      content: '✓';
      position: absolute;
      color: var(--bg-color);
      font-size: 0.875rem;
      font-weight: 800;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    .filter-label {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-main);
      cursor: pointer;
    }
  </style>
</head>

<body>

  <div class="app-layout">
    <div id="sidebarOverlay" class="sidebar-overlay"></div>

    <button id="mobileToggle" class="toggle-btn mobile-nav-toggle" title="Abrir menú">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
        stroke-linecap="round" stroke-linejoin="round">
        <line x1="3" y1="12" x2="21" y2="12"></line>
        <line x1="3" y1="6" x2="21" y2="6"></line>
        <line x1="3" y1="18" x2="21" y2="18"></line>
      </svg>
    </button>

    <aside id="sidebar" class="sidebar">
      <div class="sidebar-header">
        <button id="themeToggle" class="toggle-btn" title="Cambiar modo">
          <svg id="sunIcon" style="display: none;" width="20" height="20" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
          </svg>
          <svg id="moonIcon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
          </svg>
        </button>
        <button id="closeSidebar" class="toggle-btn" style="display: none;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="sidebar-content">
        <div class="sidebar-section">
          <h3>Red Social</h3>
          <ul id="socialNav" class="nav-list"></ul>
        </div>

        <div class="sidebar-section">
          <h3>Gráfico</h3>
          <ul id="chartNav" class="nav-list"></ul>
        </div>

        <div id="yearFilterSection" class="sidebar-section" style="display: none;">
          <h3 id="yearFilterTitle">Años</h3>
          <ul id="yearFilterList" class="filter-list"></ul>
        </div>
      </div>
    </aside>

    <main class="main-content">
      <button id="desktopToggle" class="toggle-btn desktop-toggle" title="Alternar menú">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="9" y1="3" x2="9" y2="21"></line>
        </svg>
      </button>

      <div class="dashboard-container">
        <h1 id="pageHeading">Dashboard RRSS ObSBA</h1>

        <div class="chart-card">
          <div class="card-title" id="cardTitle">Seleccione una red y un gráfico</div>
          <div id="chart_area">Cargando...</div>
          <div id="auxGroup" class="aux-group">
            <div id="auxSubtitle" class="aux-subtitle"></div>
            <div id="auxCardsContainer"></div>
          </div>
          <div id="chartInfo" class="info"></div>
        </div>
      </div>
    </main>
  </div>


  <script>
    /* ========== CONFIG: GIDs y mapeo de gráficos ========== */
    const SHEET_ID = '17nld9mh3PtcOSPkKU2VxFGIkUD3w8IaZ1VyuR2XhtN8';

    const SHEETS = {
      "General": { gid: "936287352", label: "HomePage" },
      "Instagram": { gid: "2147310482", label: "Instagram" },
      "Facebook": { gid: "708910305", label: "Facebook" },
      "X": { gid: "1309548050", label: "X" },
      "TikTok": { gid: "650301486", label: "TikTok" },
      "YouTube": { gid: "398717676", label: "YouTube" }
    };

    const CHARTS_BY_SHEET = {
      "General": {
        "promedios": {
          label: "Promedios generales",
          query: `SELECT A, B, C, D WHERE A IS NOT NULL AND (B IS NOT NULL OR C IS NOT NULL OR D IS NOT NULL) LABEL A "Año"`,
          chartType: 'ColumnChart'
        }
      },
      "Instagram": {
        "anual": {
          label: "Tasa de compromiso total",
          query: `SELECT A, B, C, D, E, F, G, H WHERE A IS NOT NULL AND (B IS NOT NULL OR C IS NOT NULL OR D IS NOT NULL) LABEL A "Año", E "Media Interacciones", F "Media Likes", G "Media Comentarios", H "Media Visualizaciones"`,
          chartType: 'ColumnChart',
          chartColumns: [0, 1, 2, 3],
          auxColumns: [4, 5, 6, 7]
        },
        "bimestral": {
          label: "Tasa de compromiso por bimestres",
          query: `SELECT M, N, O, P, Q, R, S WHERE M IS NOT NULL AND (N IS NOT NULL OR O IS NOT NULL OR P IS NOT NULL OR Q IS NOT NULL OR R IS NOT NULL OR S IS NOT NULL) LABEL M "Año"`,
          chartType: 'ColumnChart'
        },
        "tipo_post": {
          label: "Anual. Por tipo de publicación",
          query: `SELECT J, K, L WHERE J IS NOT NULL AND (K IS NOT NULL OR L IS NOT NULL) LABEL J "Año"`,
          chartType: 'ColumnChart'
        },
        "Top_Anual": {
          label: "Top publicaciones anuales",
          query: `SELECT U, V, W, X, Y, AA WHERE U IS NOT NULL AND (V IS NOT NULL OR W IS NOT NULL OR X IS NOT NULL OR Y IS NOT NULL OR AA IS NOT NULL) LABEL U "Top"`,
          chartType: 'Card',
          cardTemplate: 'topAnual'
        },
        "Top_Bimestral": {
          label: "Top publicaciones Bimestrales",
          query: `SELECT AB, AC, AE, AF, AH, AI, AK WHERE AB IS NOT NULL AND (AC IS NOT NULL OR AE IS NOT NULL OR AF IS NOT NULL OR AH IS NOT NULL OR AI IS NOT NULL OR AK IS NOT NULL) LABEL AB "Bimestre"`,
          chartType: 'Card',
          cardTemplate: 'topBimestral'
        }
      },
      "Facebook": {
        "anual": {
          label: "Tasa de compromiso total",
          query: `SELECT A, B, C, D, E, F, G, H WHERE A IS NOT NULL AND (B IS NOT NULL OR C IS NOT NULL OR D IS NOT NULL) LABEL A "Año", B "ObSBA", C "Promedio Mercado", D "Promedio salud", E "Media Interacciones", F "Media Likes", G "Media Comentarios", H "Media Visualizaciones"`,
          chartType: 'ColumnChart',
          chartColumns: [0, 1, 2, 3],
          auxColumns: [4, 5, 6, 7]
        },
        "bimestral": {
          label: "Tasa de compromiso por bimestres.",
          query: `SELECT M, N, O, P, Q, R, S WHERE M IS NOT NULL AND (N IS NOT NULL OR O IS NOT NULL OR P IS NOT NULL OR Q IS NOT NULL OR R IS NOT NULL OR S IS NOT NULL) LABEL M 'Bimestre'`,
          chartType: 'ColumnChart'
        },
        "tipo_post": {
          label: "Facebook anual. Por tipo de publicación",
          query: `SELECT I, J, K, L WHERE I IS NOT NULL AND (J IS NOT NULL OR K IS NOT NULL OR L IS NOT NULL) LABEL I "Año"`,
          chartType: 'ColumnChart'
        },
        "Top_Anual": {
          label: "Top publicaciones anuales",
          query: `SELECT T, U, V, W, X, Z WHERE T IS NOT NULL AND (U IS NOT NULL OR V IS NOT NULL OR W IS NOT NULL OR X IS NOT NULL OR Z IS NOT NULL) LABEL T "Top"`,
          chartType: 'Card',
          cardTemplate: 'topAnual'
        },
        "Top_Bimestral": {
          label: "Top publicaciones Bimestrales",
          query: `SELECT AB, AC, AE, AF, AH, AI, AK WHERE AB IS NOT NULL AND (AC IS NOT NULL OR AE IS NOT NULL OR AF IS NOT NULL OR AH IS NOT NULL OR AI IS NOT NULL OR AK IS NOT NULL) LABEL AB "Bimestre"`,
          chartType: 'Card',
          cardTemplate: 'topBimestral'
        }
      },
      "X": {
        "anual": {
          label: "Tasa de compromiso total",
          query: `SELECT A, B, C, D, E, F, G, H WHERE A IS NOT NULL AND (B IS NOT NULL OR C IS NOT NULL OR D IS NOT NULL) LABEL A "Año", B "ObSBA", C "Promedio Mercado", D "Promedio salud", E "Media Interacciones", F "Media Likes", G "Media Comentarios", H "Media Visualizaciones"`,
          chartType: 'ColumnChart',
          chartColumns: [0, 1, 2, 3],
          auxColumns: [4, 5, 6, 7]
        },
        "bimestral": {
          label: "Tasa de compromiso por bimestres",
          query: `SELECT N, O, P, Q, R, S, T WHERE N IS NOT NULL AND (O IS NOT NULL OR P IS NOT NULL OR Q IS NOT NULL OR R IS NOT NULL OR S IS NOT NULL OR T IS NOT NULL) LABEL N 'Bimestre'`,
          chartType: 'ColumnChart'
        },
        "bimestres_tipo_2025": {
          label: "2025: TC por bimestres y tipo",
          query: `SELECT V, W, X WHERE V IS NOT NULL AND (W IS NOT NULL OR X IS NOT NULL) LABEL V 'Bimestre'`,
          chartType: 'ColumnChart'
        },
        "tipo_por_anio": {
          label: "TC por año y tipo",
          query: `SELECT J, K, L WHERE J IS NOT NULL AND (K IS NOT NULL OR L IS NOT NULL) LABEL J 'Año'`,
          chartType: 'ColumnChart'
        },
        "Top_Anual": {
          label: "Top publicaciones anuales",
          query: `SELECT AA, AB, AC, AD, AE, AG WHERE AA IS NOT NULL AND (AB IS NOT NULL OR AC IS NOT NULL OR AD IS NOT NULL OR AE IS NOT NULL OR AG IS NOT NULL) LABEL AA "Top"`,
          chartType: 'Card',
          cardTemplate: 'topAnual'
        },
        "Top_Bimestral": {
          label: "Top publicaciones Bimestrales",
          query: `SELECT AH, AI, AK, AL, AN, AO, AQ WHERE AH IS NOT NULL AND (AI IS NOT NULL OR AK IS NOT NULL OR AL IS NOT NULL OR AN IS NOT NULL OR AO IS NOT NULL OR AQ IS NOT NULL) LABEL AH "Bimestre"`,
          chartType: 'Card',
          cardTemplate: 'topBimestral'
        }
      },
      "TikTok": {
        "anual": {
          label: "Tasa de compromiso total",
          query: `SELECT A, B, C, D, E, F, G, H WHERE A IS NOT NULL AND (B IS NOT NULL OR C IS NOT NULL OR D IS NOT NULL) LABEL A "Año",B "ObSBA", C "Promedio Mercado", D "Promedio salud", E "Media Interacciones", F "Media Likes", G "Media Comentarios", H "Media Visualizaciones"`,
          chartType: 'ColumnChart',
          chartColumns: [0, 1, 2, 3],
          auxColumns: [4, 5, 6, 7]
        },
        "bimestral": {
          label: "Tasa de compromiso. Visualizaciones. Bimestral",
          query: `SELECT O, P, Q, R, S, T, U WHERE O IS NOT NULL AND (P IS NOT NULL OR Q IS NOT NULL OR R IS NOT NULL OR S IS NOT NULL OR T IS NOT NULL OR U IS NOT NULL) LABEL O 'Bimestre'`,
          chartType: 'ColumnChart'
        },
        "bimestres_tipo": {
          label: "Tasa de compromiso. Por bimestres",
          query: `SELECT W, X, Y, Z WHERE W IS NOT NULL AND (X IS NOT NULL OR Y IS NOT NULL OR Z IS NOT NULL) LABEL W 'Bimestre'`,
          chartType: 'ColumnChart'
        },
        "tipo_x_anio": {
          label: "Anual. Por tipo de publicación",
          query: `SELECT J, K, L, M WHERE J IS NOT NULL AND (K IS NOT NULL OR L IS NOT NULL OR M IS NOT NULL) LABEL J 'Año'`,
          chartType: 'ColumnChart'
        },
        "Top_Anual": {
          label: "Top publicaciones anuales",
          query: `SELECT AB, AC, AD, AE, AF, AH WHERE AB IS NOT NULL AND (AC IS NOT NULL OR AD IS NOT NULL OR AE IS NOT NULL OR AF IS NOT NULL OR AH IS NOT NULL) LABEL AB "Top"`,
          chartType: 'Card',
          cardTemplate: 'topAnual'
        },
        "Top_Bimestral": {
          label: "Top publicaciones Bimestrales",
          query: `SELECT AI, AJ, AL, AM, AO, AP, AR WHERE AI IS NOT NULL AND (AJ IS NOT NULL OR AL IS NOT NULL OR AM IS NOT NULL OR AO IS NOT NULL OR AP IS NOT NULL OR AR IS NOT NULL) LABEL AI "Bimestre"`,
          chartType: 'Card',
          cardTemplate: 'topBimestral'
        }
      },
      "YouTube": {
        "anual": {
          label: "Tasa de compromiso total",
          query: `SELECT A, B, C, D, E, F, G WHERE A IS NOT NULL AND (B IS NOT NULL OR C IS NOT NULL) LABEL A "Año", B "ObSBA", C "Promedio Mercado", D "Media Interacciones", E "Media Likes", F "Media Comentarios", G "Media Visualizaciones"`,
          chartType: 'ColumnChart',
          chartColumns: [0, 1, 2],
          auxColumns: [3, 4, 5, 6]
        },
        "bimestral": {
          label: "Tasa de compromiso total. Por bimestres",
          query: `SELECT T, U, V, W, X, Y, Z WHERE T IS NOT NULL AND (U IS NOT NULL OR V IS NOT NULL OR W IS NOT NULL OR X IS NOT NULL OR Y IS NOT NULL OR Z IS NOT NULL) LABEL T 'Bimestre'`,
          chartType: 'ColumnChart'
        },
        "tc_shorts_anual": {
          label: "Tasa de compromiso en SHORTS",
          query: `SELECT H, I, J WHERE H IS NOT NULL AND (I IS NOT NULL OR J IS NOT NULL) LABEL H 'Año'`,
          chartType: 'ColumnChart'
        },
        "tc_video_anual": {
          label: "Tasa de compromiso en VIDEOS",
          query: `SELECT N, O, P WHERE N IS NOT NULL AND (O IS NOT NULL OR P IS NOT NULL) LABEL N 'Año'`,
          chartType: 'ColumnChart'
        },
        "tc_shorts_bimestral": {
          label: "Tasa de compromiso en SHORTS. Por bimestres",
          query: `SELECT AA, AB, AC, AD, AE, AF, AG WHERE AA IS NOT NULL AND (AB IS NOT NULL OR AC IS NOT NULL OR AD IS NOT NULL OR AE IS NOT NULL OR AF IS NOT NULL OR AG IS NOT NULL) LABEL AA 'Bimestre'`,
          chartType: 'ColumnChart'
        },
        "tipo_x_anio": {
          label: "Tasa de compromiso total por tipo de publicación",
          query: `SELECT K, L, M WHERE K IS NOT NULL AND (L IS NOT NULL OR M IS NOT NULL) LABEL K 'Año'`,
          chartType: 'ColumnChart'
        },
        "tc_2025_bimestres_tipo": {
          label: "Tasa de compromiso 2025. Por bimestres",
          query: `SELECT Q, R, S WHERE Q IS NOT NULL AND (R IS NOT NULL OR S IS NOT NULL) LABEL Q 'Bimestre'`,
          chartType: 'ColumnChart'
        },
        "Top_Anual": {
          label: "Top publicaciones anuales",
          query: `SELECT AI, AJ, AK, AL, AM, AO WHERE AI IS NOT NULL AND (AJ IS NOT NULL OR AK IS NOT NULL OR AL IS NOT NULL OR AM IS NOT NULL OR AO IS NOT NULL) LABEL AI "Top"`,
          chartType: 'Card',
          cardTemplate: 'topAnual'
        },
        "Top_Bimestral": {
          label: "Top publicaciones Bimestrales",
          query: `SELECT AP, AQ, AS, AT, AV, AW, AY WHERE AP IS NOT NULL AND (AQ IS NOT NULL OR AS IS NOT NULL OR AT IS NOT NULL OR AV IS NOT NULL OR AW IS NOT NULL OR AY IS NOT NULL) LABEL AP "Bimestre"`,
          chartType: 'Card',
          cardTemplate: 'topBimestral'
        }
      }
    };

    const COLORS = ['#38bdf8', '#818cf8', '#34d399', '#fbbf24', '#f87171', '#a78bfa', '#22d3ee', '#94a3b8'];

    let currentSocial = "General";
    let currentChart = "";
    let lastWidth = window.innerWidth;
    let selectedFilters = new Set();
    let currentData = null;
    let currentChartCfg = null;

    /* ========== Inicializar Google Charts ========== */
    google.charts.load('current', { packages: ['corechart'] });
    google.charts.setOnLoadCallback(initUI);

    function initUI() {
      const socialNav = document.getElementById('socialNav');
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      const mobileToggle = document.getElementById('mobileToggle');
      const desktopToggle = document.getElementById('desktopToggle');
      const closeSidebar = document.getElementById('closeSidebar');

      // Sidebar Toggle Logic
      const toggleSidebar = () => {
        if (window.innerWidth < 1024) {
          sidebar.classList.toggle('active');
          overlay.classList.toggle('active');
        } else {
          sidebar.classList.toggle('collapsed');
          // Redraw chart after collapse animation
          setTimeout(loadSelectedChart, 350);
        }
      };

      mobileToggle.onclick = toggleSidebar;
      desktopToggle.onclick = toggleSidebar;
      overlay.onclick = toggleSidebar;

      // Theme toggle logic
      const themeToggle = document.getElementById('themeToggle');
      const sunIcon = document.getElementById('sunIcon');
      const moonIcon = document.getElementById('moonIcon');

      const applyTheme = (isLight) => {
        if (isLight) {
          document.body.classList.add('light-mode');
          sunIcon.style.display = 'block';
          moonIcon.style.display = 'none';
        } else {
          document.body.classList.remove('light-mode');
          sunIcon.style.display = 'none';
          moonIcon.style.display = 'block';
        }
        // Redraw chart with new colors
        loadSelectedChart();
      };

      const savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'light') applyTheme(true);

      themeToggle.onclick = () => {
        const isLight = document.body.classList.toggle('light-mode');
        localStorage.setItem('theme', isLight ? 'light' : 'dark');
        applyTheme(isLight);
      };

      // Show close button on mobile only
      if (window.innerWidth < 1024) {
        closeSidebar.style.display = 'flex';
        closeSidebar.onclick = toggleSidebar;
        themeToggle.style.marginRight = 'auto'; // Align theme toggle to left when close is visible
      } else {
        themeToggle.style.marginLeft = 'auto'; // Align theme toggle to right
      }

      socialNav.innerHTML = '';
      Object.keys(SHEETS).forEach(k => {
        const li = document.createElement('li');
        li.className = 'nav-item';
        const btn = document.createElement('button');
        btn.className = 'nav-btn';
        btn.dataset.social = k;
        btn.textContent = SHEETS[k].label || k;
        btn.onclick = () => {
          document.querySelectorAll('#socialNav .nav-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentSocial = k;
          populateChartsFor(k);
        };
        li.appendChild(btn);
        socialNav.appendChild(li);

        if (k === currentSocial) btn.classList.add('active');
      });

      populateChartsFor(currentSocial);

      // Redraw on resize only if width changed (to avoid issues on mobile scroll)
      window.addEventListener('resize', debounce(() => {
        if (window.innerWidth !== lastWidth) {
          lastWidth = window.innerWidth;
          loadSelectedChart();
        }
      }, 250));
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    function populateChartsFor(socialKey) {
      const chartNav = document.getElementById('chartNav');
      chartNav.innerHTML = '';

      const charts = CHARTS_BY_SHEET[socialKey] || {};
      const keys = Object.keys(charts);

      keys.forEach((key, index) => {
        const li = document.createElement('li');
        li.className = 'nav-item';
        const btn = document.createElement('button');
        btn.className = 'nav-btn';
        btn.dataset.chart = key;
        btn.textContent = charts[key].label;
        btn.onclick = () => {
          document.querySelectorAll('#chartNav .nav-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentChart = key;
          selectedFilters.clear(); // Clear filters when changing chart
          loadSelectedChart();
        };
        li.appendChild(btn);
        chartNav.appendChild(li);

        if (index === 0) {
          btn.classList.add('active');
          currentChart = key;
        }
      });

      document.getElementById('cardTitle').textContent = `${SHEETS[socialKey].label} — ${charts[currentChart]?.label || ''}`;
      selectedFilters.clear(); // Reset filters when changing social/chart set
      loadSelectedChart();
    }

    function loadSelectedChart() {
      const social = currentSocial;
      const chartKey = currentChart;
      const chartCfg = CHARTS_BY_SHEET[social]?.[chartKey];

      const infoDiv = document.getElementById('chartInfo');
      const chartArea = document.getElementById('chart_area');
      const auxContainer = document.getElementById('auxCardsContainer');
      const subtitle = document.getElementById('auxSubtitle');
      const auxGroup = document.getElementById('auxGroup');

      subtitle.textContent = '';
      if (!chartCfg) {
        chartArea.innerHTML = 'No hay configuración para este gráfico.';
        return;
      }

      document.getElementById('cardTitle').textContent = `${SHEETS[social].label} — ${chartCfg.label}`;
      infoDiv.textContent = '';
      auxContainer.innerHTML = '';
      if (auxGroup) auxGroup.style.display = 'none';

      currentChartCfg = chartCfg;
      const gid = SHEETS[social].gid;
      const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${gid}&tqx=out:json&tq=${encodeURIComponent(chartCfg.query)}`;

      chartArea.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:200px">Cargando datos...</div>';

      fetch(url)
        .then(r => {
          if (!r.ok) throw new Error('HTTP ' + r.status);
          return r.text();
        })
        .then(text => {
          const m = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*?)\);/);
          if (!m) throw new Error('No se pudo parsear la respuesta');

          const json = JSON.parse(m[1]);
          if (!json.table || !json.table.cols?.length) throw new Error('La hoja no devolvió columnas');

          const originalTable = new google.visualization.DataTable(json.table);
          currentData = originalTable;

          // Update filters UI if it's the first load for this chart
          if (selectedFilters.size === 0) {
            updateFilterUI(originalTable);
          }

          if (chartCfg.chartType === 'Card') {
            renderCards(filterDataTable(originalTable), chartCfg.cardTemplate || 'topAnual');
            auxContainer.innerHTML = '';
            return;
          }

          let dataTable = filterDataTable(originalTable);
          if (Array.isArray(chartCfg.chartColumns)) {
            dataTable = buildChartTable(originalTable, chartCfg.chartColumns);
          }

          if (dataTable.getNumberOfRows() > 0 && dataTable.getColumnType(0) === 'number') {
            const forced = new google.visualization.DataTable();
            forced.addColumn('string', dataTable.getColumnLabel(0));
            for (let c = 1; c < dataTable.getNumberOfColumns(); c++) {
              forced.addColumn(dataTable.getColumnType(c), dataTable.getColumnLabel(c));
            }
            for (let r = 0; r < dataTable.getNumberOfRows(); r++) {
              const row = [String(dataTable.getValue(r, 0))];
              for (let c = 1; c < dataTable.getNumberOfColumns(); c++) {
                row.push(dataTable.getValue(r, c));
              }
              forced.addRow(row);
            }
            dataTable = forced;
          }

          const annotated = new google.visualization.DataTable();
          annotated.addColumn(dataTable.getColumnType(0), dataTable.getColumnLabel(0));
          for (let c = 1; c < dataTable.getNumberOfColumns(); c++) {
            const type = dataTable.getColumnType(c);
            annotated.addColumn(type, dataTable.getColumnLabel(c));
            if (type === 'number') annotated.addColumn({ type: 'string', role: 'annotation' });
          }

          for (let r = 0; r < dataTable.getNumberOfRows(); r++) {
            const row = [dataTable.getValue(r, 0)];
            for (let c = 1; c < dataTable.getNumberOfColumns(); c++) {
              const v = dataTable.getValue(r, c);
              const isNumber = dataTable.getColumnType(c) === 'number';
              const formatted = (v != null && !isNaN(v) && isNumber)
                ? v.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })
                : (v != null ? v.toString() : '');

              row.push({ v: v, f: formatted });
              if (isNumber) {
                row.push(formatted);
              }
            }
            annotated.addRow(row);
          }

          dataTable = annotated;
          const options = buildOptions(chartCfg.label, dataTable.getNumberOfColumns() - 1);

          let chartObj;
          switch (chartCfg.chartType) {
            case 'LineChart': chartObj = new google.visualization.LineChart(chartArea); break;
            case 'BarChart': chartObj = new google.visualization.BarChart(chartArea); break;
            default: chartObj = new google.visualization.ColumnChart(chartArea);
          }

          let seriesCount = 0;
          for (let c = 0; c < dataTable.getNumberOfColumns(); c++) {
            if (dataTable.getColumnType(c) === 'number') seriesCount++;
          }

          options.colors = COLORS.slice(0, seriesCount);
          chartObj.draw(dataTable, options);

          google.visualization.events.addListener(chartObj, 'select', () => {
            const selection = chartObj.getSelection();
            if (!selection.length) return;
            const row = selection[0].row;
            updateAuxCardsByRow(row, originalTable, chartCfg);
          });

          if (Array.isArray(chartCfg.auxColumns)) {
            updateAuxCardsByRow(0, filterDataTable(originalTable), chartCfg);
          }
        })
        .catch(err => {
          chartArea.innerHTML = `<span style="color:var(--danger);font-weight:700;">Error: ${err.message}</span>`;
          console.error(err);
        });
    }

    function updateFilterUI(dataTable) {
      const filterSection = document.getElementById('yearFilterSection');
      const filterList = document.getElementById('yearFilterList');
      const filterTitle = document.getElementById('yearFilterTitle');

      filterList.innerHTML = '';

      const label = currentChartCfg?.label || '';
      // Normalización para comparar (sin puntos, todo a minúsculas, etc)
      const normalizedLabel = label.toLowerCase();
      const isAllowed = normalizedLabel.includes("tasa de compromiso total") ||
        normalizedLabel.includes("tasa de compromiso por bimestres") ||
        normalizedLabel.includes("por tipo de publicación") ||
        normalizedLabel.includes("tc por año y tipo");

      if (!isAllowed) {
        filterSection.style.display = 'none';
        selectedFilters.clear();
        return;
      }

      const colLabel = dataTable.getColumnLabel(0);
      filterTitle.textContent = colLabel === 'Año' ? 'Años' : `Filtrar por ${colLabel}`;

      const values = [];
      for (let r = 0; r < dataTable.getNumberOfRows(); r++) {
        const val = String(dataTable.getValue(r, 0));
        if (!values.includes(val)) values.push(val);
      }

      if (values.length <= 1) {
        filterSection.style.display = 'none';
        return;
      }

      filterSection.style.display = 'block';
      selectedFilters = new Set(values); // Default all selected

      values.forEach(val => {
        const li = document.createElement('li');
        li.className = 'filter-item';

        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.id = `filter_${val}`;
        cb.checked = true;
        cb.onchange = () => {
          if (cb.checked) selectedFilters.add(val);
          else selectedFilters.delete(val);
          renderFilteredChart();
        };

        const label = document.createElement('label');
        label.className = 'filter-label';
        label.setAttribute('for', `filter_${val}`);
        label.textContent = val;

        li.appendChild(cb);
        li.appendChild(label);
        filterList.appendChild(li);
      });
    }

    function filterDataTable(sourceTable) {
      if (selectedFilters.size === 0) return sourceTable;

      const view = new google.visualization.DataView(sourceTable);
      const rows = [];
      for (let r = 0; r < sourceTable.getNumberOfRows(); r++) {
        if (selectedFilters.has(String(sourceTable.getValue(r, 0)))) {
          rows.push(r);
        }
      }
      view.setRows(rows);

      // We need a DataTable, not a DataView, because some parts of code use getColumnLabel etc on it
      // and others might need to add columns (like annotations)
      const dt = new google.visualization.DataTable();
      for (let c = 0; c < sourceTable.getNumberOfColumns(); c++) {
        dt.addColumn(sourceTable.getColumnType(c), sourceTable.getColumnLabel(c));
      }
      for (let i = 0; i < rows.length; i++) {
        const row = [];
        for (let c = 0; c < sourceTable.getNumberOfColumns(); c++) {
          row.push(sourceTable.getValue(rows[i], c));
        }
        dt.addRow(row);
      }
      return dt;
    }

    function renderFilteredChart() {
      if (!currentData || !currentChartCfg) return;

      const chartCfg = currentChartCfg;
      const originalTable = currentData;
      const chartArea = document.getElementById('chart_area');
      const auxContainer = document.getElementById('auxCardsContainer');
      const auxGroup = document.getElementById('auxGroup');

      if (chartCfg.chartType === 'Card') {
        renderCards(filterDataTable(originalTable), chartCfg.cardTemplate || 'topAnual');
        return;
      }

      let dataTable = filterDataTable(originalTable);

      if (Array.isArray(chartCfg.chartColumns)) {
        dataTable = buildChartTable(dataTable, chartCfg.chartColumns);
      }

      if (dataTable.getNumberOfRows() > 0 && dataTable.getColumnType(0) === 'number') {
        const forced = new google.visualization.DataTable();
        forced.addColumn('string', dataTable.getColumnLabel(0));
        for (let c = 1; c < dataTable.getNumberOfColumns(); c++) {
          forced.addColumn(dataTable.getColumnType(c), dataTable.getColumnLabel(c));
        }
        for (let r = 0; r < dataTable.getNumberOfRows(); r++) {
          const row = [String(dataTable.getValue(r, 0))];
          for (let c = 1; c < dataTable.getNumberOfColumns(); c++) {
            row.push(dataTable.getValue(r, c));
          }
          forced.addRow(row);
        }
        dataTable = forced;
      }

      const annotated = new google.visualization.DataTable();
      annotated.addColumn(dataTable.getColumnType(0), dataTable.getColumnLabel(0));
      for (let c = 1; c < dataTable.getNumberOfColumns(); c++) {
        const type = dataTable.getColumnType(c);
        annotated.addColumn(type, dataTable.getColumnLabel(c));
        if (type === 'number') annotated.addColumn({ type: 'string', role: 'annotation' });
      }

      for (let r = 0; r < dataTable.getNumberOfRows(); r++) {
        const row = [dataTable.getValue(r, 0)];
        for (let c = 1; c < dataTable.getNumberOfColumns(); c++) {
          const v = dataTable.getValue(r, c);
          const isNumber = dataTable.getColumnType(c) === 'number';
          const formatted = (v != null && !isNaN(v) && isNumber)
            ? v.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })
            : (v != null ? v.toString() : '');

          row.push({ v: v, f: formatted });
          if (isNumber) {
            row.push(formatted);
          }
        }
        annotated.addRow(row);
      }

      dataTable = annotated;
      const options = buildOptions(chartCfg.label, dataTable.getNumberOfColumns() - 1);

      let chartObj;
      switch (chartCfg.chartType) {
        case 'LineChart': chartObj = new google.visualization.LineChart(chartArea); break;
        case 'BarChart': chartObj = new google.visualization.BarChart(chartArea); break;
        default: chartObj = new google.visualization.ColumnChart(chartArea);
      }

      let seriesCount = 0;
      for (let c = 0; c < dataTable.getNumberOfColumns(); c++) {
        if (dataTable.getColumnType(c) === 'number') seriesCount++;
      }

      options.colors = COLORS.slice(0, seriesCount);
      chartObj.draw(dataTable, options);

      google.visualization.events.addListener(chartObj, 'select', () => {
        const selection = chartObj.getSelection();
        if (!selection.length) return;
        const row = selection[0].row;
        // Need to use the filtered table to find the correct data from originalTable
        // or just pass the filtered row data
        updateAuxCardsByRow(row, filterDataTable(originalTable), chartCfg);
      });

      if (Array.isArray(chartCfg.auxColumns)) {
        updateAuxCardsByRow(0, filterDataTable(originalTable), chartCfg);
      }
    }

    function buildOptions(title, seriesCount) {
      const isMobile = window.innerWidth < 768;
      const isLight = document.body.classList.contains('light-mode');

      const textColor = isLight ? '#1e293b' : '#94a3b8';
      const secondaryTextColor = isLight ? '#64748b' : '#94a3b8';
      const gridlineColor = isLight ? '#e2e8f0' : '#1e293b';
      const baselineColor = isLight ? '#cbd5e1' : '#334155';
      const annotationColor = isLight ? '#0f172a' : '#f1f5f9';

      return {
        title: '', // Remove internal title to use our own
        fontName: 'Open Sans',
        chartArea: {
          left: isMobile ? 30 : 80,
          top: 40,
          right: isMobile ? 5 : 30,
          bottom: isMobile ? 60 : 80,
          width: '100%',
          height: '100%'
        },
        legend: {
          position: isMobile ? 'top' : 'bottom',
          textStyle: { fontSize: 12, color: secondaryTextColor },
          maxLines: 3
        },
        hAxis: {
          textStyle: { fontSize: 11, color: secondaryTextColor },
          gridlines: { color: 'transparent' },
          baselineColor: baselineColor
        },
        vAxis: {
          textStyle: { fontSize: 11, color: secondaryTextColor },
          gridlines: { color: gridlineColor },
          baselineColor: baselineColor,
          format: 'short'
        },
        animation: { startup: true, duration: 800, easing: 'out' },
        annotations: {
          alwaysOutside: true,
          textStyle: { fontSize: isMobile ? 10 : 11, bold: true, color: annotationColor }
        },
        backgroundColor: 'transparent',
        bar: { groupWidth: isMobile ? '85%' : '75%' }
      };
    }

    function buildChartTable(sourceTable, chartColumns) {
      const dt = new google.visualization.DataTable();
      chartColumns.forEach((colIdx) => {
        dt.addColumn(sourceTable.getColumnType(colIdx), sourceTable.getColumnLabel(colIdx));
      });
      for (let r = 0; r < sourceTable.getNumberOfRows(); r++) {
        const row = chartColumns.map(c => sourceTable.getValue(r, c));
        dt.addRow(row);
      }
      return dt;
    }

    const CARD_TEMPLATES = {
      topAnual: renderTopAnualCard,
      topBimestral: renderTopBimestralCard
    };

    function renderCards(dataTable, template) {
      const chartArea = document.getElementById('chart_area');
      const infoDiv = document.getElementById('chartInfo');

      chartArea.innerHTML = '';
      infoDiv.textContent = '';

      if (!dataTable || dataTable.getNumberOfRows() === 0) {
        chartArea.innerHTML = '<div style="color:var(--danger)">No hay datos para mostrar.</div>';
        return;
      }

      const renderFn = CARD_TEMPLATES[template];
      if (!renderFn) {
        chartArea.innerHTML = `<div style="color:var(--danger)">Template "${template}" no definido</div>`;
        return;
      }

      let html = `<div class="card-grid">`;
      for (let r = 0; r < dataTable.getNumberOfRows(); r++) {
        html += renderFn(dataTable, r);
      }
      html += `</div>`;
      chartArea.innerHTML = html;
    }

    function renderTopAnualCard(dt, r) {
      const rank = r + 1;
      const tc = Number(dt.getValue(r, 1) || 0);
      const views = dt.getValue(r, 2) ?? '-';
      const reactions = dt.getValue(r, 3) ?? '-';
      const comments = dt.getValue(r, 4) ?? '-';
      let link = dt.getValue(r, 5);
      if (link && typeof link === 'object' && link.v) link = link.v;
      const tcText = tc.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

      return `
    <div class="card card-top">
      <div class="card-rank">Top ${rank}</div>
      <div class="card-main">TC ${tcText}</div>
      <div class="card-stats">
        <strong>Visualizaciones:</strong> ${views}<br/>
        <strong>Reacciones:</strong> ${reactions}<br/>
        <strong>Comentarios:</strong> ${comments}
      </div>
      ${link ? `<a href="${link}" target="_blank" class="card-link"><span>Ver publicación</span></a>` : `<span style="color:var(--text-muted)">Link no disponible</span>`}
    </div>
  `;
    }

    function renderTopBimestralCard(dt, r) {
      const bimestre = dt.getValue(r, 0) ?? '';
      function formatTC(value) {
        return Number(value || 0).toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      }
      function normalizeLink(v) {
        if (!v) return null;
        if (typeof v === 'object' && v.v) v = v.v;
        if (typeof v === 'string' && v.trim().length > 0) return v.trim();
        return null;
      }

      const top1 = formatTC(dt.getValue(r, 1));
      const link1 = normalizeLink(dt.getValue(r, 2));
      const top2 = formatTC(dt.getValue(r, 3));
      const link2 = normalizeLink(dt.getValue(r, 4));
      const top3 = formatTC(dt.getValue(r, 5));
      const link3 = normalizeLink(dt.getValue(r, 6));

      return `
    <div class="card card-top">
      <div class="card-rank">${bimestre}</div>
      <div class="card-stats">
        <strong>Top 1:</strong> ${top1}<br/>
        ${link1 ? `<a class="card-link" href="${link1}" target="_blank">Ver publicación</a>` : '<span style="color:var(--text-muted)">Link no disponible</span>'}
        <hr/>
        <strong>Top 2:</strong> ${top2}<br/>
        ${link2 ? `<a class="card-link" href="${link2}" target="_blank">Ver publicación</a>` : '<span style="color:var(--text-muted)">Link no disponible</span>'}
        <hr/>
        <strong>Top 3:</strong> ${top3}<br/>
        ${link3 ? `<a class="card-link" href="${link3}" target="_blank">Ver publicación</a>` : '<span style="color:var(--text-muted)">Link no disponible</span>'}
      </div>
    </div>
  `;
    }

    function updateAuxCardsByRow(row, dataTable, chartCfg) {
      const container = document.getElementById('auxCardsContainer');
      const subtitle = document.getElementById('auxSubtitle');
      const auxGroup = document.getElementById('auxGroup');

      container.innerHTML = '';
      if (!chartCfg.auxColumns || !chartCfg.auxColumns.length || dataTable.getNumberOfRows() === 0) {
        if (auxGroup) auxGroup.style.display = 'none';
        return;
      }

      if (auxGroup) auxGroup.style.display = 'flex';

      const year = dataTable.getValue(row, 0);
      subtitle.textContent = `Detalle año: ${year}`;

      chartCfg.auxColumns.forEach(colIndex => {
        const label = dataTable.getColumnLabel(colIndex);
        let value = dataTable.getValue(row, colIndex);
        if (value === null || value === undefined) return;
        if (!isNaN(value)) value = Number(value).toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

        const card = document.createElement('div');
        card.className = 'aux-card';
        card.innerHTML = `
      <div class="aux-row">
        <span class="aux-label">${label}</span>
        <span class="aux-value">${value}</span>
      </div>
    `;
        container.appendChild(card);
      });
    }

  </script>
</body>

</html>